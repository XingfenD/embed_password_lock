## introduction

​	在智能仪表中，经常会用到键盘、数码管等外设。因此，一个稳定、占用系统资源少的人机对话通道设计非常重要。传统的键盘与数码管解决方案，由于键盘与数码管是分离的，因而电路连接比较复杂，不管是独立式键盘还是矩阵式键盘，都会浪费微控制器的端口资源，而且都需要人为进行去抖动处理，且抗干扰性差。而数码管部分，不管是静态显示方式还是动态显示方式，在不进行锁存器扩展的前提下。仍然要占用 8 根 I/O 端口线，这将严重浪费系统的端口资源。

​	ZLG7290B 是广州周立功单片机发展有限公司自行设计的数码管显示驱动及键盘扫描管理芯片。能够直接驱动 8 位共阴式数码管（或 64 只独立的 LED），同时还可以扫描管理多达 64 只按键。其中有8只按键还可以作为功能键使用，就像电脑键盘上的 Ctrl、Shift、Alt 键一样。另外 ZLG7290B 内部还设置有连击计数器，能够使某键按下后不松手而连续有效。采用 I2C 总线方式，与微控制器的接口仅需两根信号线。该芯片为工业级芯片，抗干扰能力强，在工业测控中已有大量应用。

​	ZLG7290B 可以扫描管理多达 64 个按键，K1～K56 为普通按键，F0～F7 为功能键。普通按键还有连击检测功能。ZLG7290B 内部有 8 个显示缓冲寄存器 DpRam0～DpRam7，（本实验采用的是直接写显示缓冲寄存器，它们地址分别是 10H~17H）它们直接决定数码管显示的内容。ZLG7290B 提供有两种显示控制方式，一种是直接向显存写入字型数据，另一种是通过向命令缓冲寄存器写入控制指令实现自动译码显示。访问这些寄存器需要通过 I2C 总线接口来实现。ZLG7290B 的 I2C 总线器件地址是 70H（写操作）和71H（读操作）。访问内部寄存器要通过“子地址”来实现。

​	在这里介绍本实验用到的几个寄存器作用：


### 系统寄存器 SystemReg（地址：00H）

​	系统寄存器的第 0 位（LSB）称作 KeyAvi，标志着按键是否有效，0－没有按键被按下，1－有某个按键被按下。SystemReg 寄存器的其它位暂时没有定义。当按下某个键时，ZLG7290B 的 INT 引脚会产生一个低电平的中断请求信号。当读走键值后，中断信号就会自动撤销。而 KeyAvi 也同时予以反映。正常情况下，微控制器只需要判断 INT 引脚就可以了。通过不断查询 KeyAvi 位也能判断是否有键按下，这样就可以节省微控制器的一根 I/O 口线，但是代价是 I2C 总线处于频繁的活动状态，多消耗电流并且不利于抗干扰。（本节采用外部中断判断 INT 引脚，不读该寄存器）

### 键值寄存器 Key（地址：01H）

​	如果某个普通键（图 3.1 中的 K1～K56）被按下，则微控制器可以从键值寄存器 Key 中读取相应的键值 1～56。如果微控制器发现 ZLG7290B 的 INT 引脚产生了中断请求，而从 Key 中读到的键值是0，则表示按下的可能是功能键。键值寄存器 Key 的值在被读走后自动变成 0。